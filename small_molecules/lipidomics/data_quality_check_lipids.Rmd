---
title: "Data Quality Check"
subtitle: "Lipidomics of Plasma (PI Name -- Institution)" # Enter a subtitle indicating project, experiment, and PI
author: "Author Name" # Confirm author of Data Quality Check report
date: "`r format(Sys.time(), '%B %d, %Y')`" # Date is autogenerated when report is rendered
output:
  html_document:
    toc: true
    number_sections: true
---

```{r SETUP, include = F}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r DQC SETUP}
# ================================ DATA QUALITY CHECK SET UP =======================================
# Add the name of your tab delimited text file containing your data within the quotes below (include the file extension .txt) e.g. "my_data.txt"
data_file <- "met_data.txt"

# Add the names of the sample groups in your data file within the list below. Each sample group should be within quotes, separated by a comma, and the names should be spelled exactly as found in the data file (including any capitalizations, underscores, etc.) e.g. c("pooled_QC", "cell line A1", "cell line A2")
sample_grps <- c("Group 27", "Group 30", "Group 33", "Group 36", "Pooled QC", "Ext PQC")

# If there are metabolites/lipids not to be analyzed, such as qualifiers, add their names below as they are found under the component_name column in the data file e.g. c("alanine_qual", "citrulline.2)
# tip: this step can be avoided by indicating under the "is" column of the data file a different letter other than 'y' or 'n' (e.g. 'r' for 'remove')
# remove_met <- c() # TO BE ADDED IN FUTURE VERSION OF DATA QUALITY CHECK DOCUMENT


```

# Internal Standard Check
## Signal Intensity

```{r IS SIGNAL INTENSITY CHECK}
# load libraries----
library(tidyverse)
library(data.table)

# load data----
met_data <- setDT(read.delim(data_file))

#  ***SIGNAL INTENSITY OF IS FOR EACH SAMPLE TYPE***
ggplot(met_data[is == "y" & sample_type %in% sample_grps & area > 0], aes(x = component_name, y = log10(area), fill = sample_type)) +
  geom_boxplot(outlier.color = NA) +
  geom_jitter(pch = 21, color = "black", position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.2)) +
  theme(
    axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5, size = 6),
    plot.background = element_rect(color = "black")
  ) +
  labs(x = "Standards", y = "log10(peak area)", fill = "Sample Group")


```

**Figure 1. Signal intensity of internal standards.** Intensities of each of the internal standards are plotted as boxplots for each sample type. Each individual sample is plotted as a single point overlaid on the boxplot. Points above or below the stems of the boxplot are outliers.

---

## Injection order

```{r INJECTION ORDER}
# ***INJECTION ORDER IS SIGNAL INTENSITY***
ggplot(met_data[is == "y" & sample_type %in% sample_grps & area > 0], aes(x = sample_no, y = log10(area), color = sample_type)) +
  geom_point(size = 1) +
  geom_line(linewidth = 0.5) +
  facet_wrap(vars(component_name)) +
  theme(
    strip.text = element_text(hjust = 0, size = 6, margin = margin()),
    plot.background = element_rect(color = "black")
  ) +
  labs(x = "Injection order", y = "log10(peak area)", color = "Sample Group")

```

**Figure 2. Signal intensity of internal standards across injection sequence.** Intensities of each of the internal standards are plotted by injection order. Colors indicate sample type.

---

# Sample Data Check

## Retention Time Variability

```{r RT CHECK}
# ***RETENTION TIME OF LIPID MOLECULAR SPECIES FOR EACH CLASS***
ggplot(met_data[is == "n" & sample_type %in% sample_grps & rt > 0 & !(is.na(area))], aes(x = component_group, y = rt, fill = sample_type)) +
  geom_boxplot(outlier.size = 0.2) +
  theme(
    axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
    plot.background = element_rect(color = "black")
  ) +
  labs(title = "RT of Lipid Classes", x = "Lipid Class", y = "RT\n(min)", fill = "Sample Group")
```

**Figure 3. Retention time of each lipid class.** Retention times are plotted as boxplots for each sample type and each lipid class.

---

## Signal Intensity of All Detected Compounds

```{r SAMPLE BOXPLOTS}
# ***SIGNAL INTENSITY OF BIOLOGICAL LIPIDS (TOTAL) FOR EACH SAMPLE***
ggplot(met_data[is == "n" & sample_type %in% sample_grps & area > 0], aes(x = paste0(sample_type,"_",sample_no), y = log10(area), fill = sample_type)) +
  geom_boxplot(outlier.color = "black") +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
        plot.background = element_rect(color = "black")) +
  labs(x = "Sample", y = "log10(peak area)", fill = "Sample Group")
```

**Figure 4. Signal intensity of biological lipids.** Boxplots show the distribution of the signal intensities for all biological lipids detected for each sample and colored by each sample type.

---

## Signal Intensity of Individual Lipid Classes

```{r LIPID CLASS SIGNAL INTENSITY CHECK, fig.height = 16, fig.width= 16}
# ***SIGNAL INTENSITY OF BIOLOGICAL METABOLITES INDIVIDUALLY FOR EACH SAMPLE***
ggplot(met_data[is == "n" & sample_type %in% sample_grps & area > 0], aes(x = paste0(sample_type,"_",sample_no), y = log10(area), fill = sample_type)) +
  geom_boxplot(outlier.color = "black", outlier.size = 0.5) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5, size = 3),
        strip.text = element_text(hjust = 0, size = 12, margin = margin()),
        plot.background = element_rect(color = "black")) +
  labs(x = "Sample", y = "log10(peak area)", fill = "Sample Group") +
  facet_wrap(vars(component_group))

```

**Figure 5. Signal intensity of each biological lipid class.** Boxplots show the distribution of the signal intensities for all biological lipids detected for each lipid class and sample, and is colored by each sample type. Each subplot represents a specific lipid class.

---

# Appendix
## R Version and Packages Used

`r R.version.string` was used to analyze the data and generate this report. The following R packages were also used:

```{r R PACKAGE VERSIONS}

otherPkgs <- names(sessionInfo()[["otherPkgs"]])
pkgs_vers <- vector("character", length(otherPkgs))
for (i in seq_along(otherPkgs)) {
  
  pkgs_vers[[i]] <- sessionInfo()[["otherPkgs"]][[otherPkgs[i]]][["Version"]]
  
}

for (i in seq_along(otherPkgs)) {
  
  print(paste0(otherPkgs[[i]], " ", pkgs_vers[[i]]))
  
}

```
