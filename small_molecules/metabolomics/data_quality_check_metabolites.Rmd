---
title: "Data Quality Check"
subtitle: "Lipid Mediators of Plasma (PI Name -- Institution)" # Enter a subtitle indicating project, experiment, and PI
author: "Author Name" # Confirm author of Data Quality Check report
date: "`r format(Sys.time(), '%B %d, %Y')`" # Date is autogenerated when report is rendered
output:
  html_document:
    toc: true
    number_sections: true
---

```{r SETUP, include = F}
knitr::opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r DQC SETUP}
# ================================ DATA QUALITY CHECK SET UP =======================================
# Add the name of your tab delimited text file containing your data within the quotes below (include the file extension .txt) e.g. "my_data.txt"
data_file <- "met_data.txt"

# Add the names of the sample groups in your data file within the list below. Each sample group should be within quotes, separated by a comma, and the names should be spelled exactly as found in the data file (including any capitalizations, underscores, etc.) e.g. c("pooled_QC", "cell line A1", "cell line A2")
sample_grps <- c("Group 27", "Group 30", "Group 33", "Group 36", "Pooled QC", "Ext PQC")

# If there are metabolites/lipids not to be analyzed, such as qualifiers, add their names below as they are found under the component_name column in the data file e.g. c("alanine_qual", "citrulline.2)
# tip: this step can be avoided by indicating under the "is" column of the data file a different letter other than 'y' or 'n' (e.g. 'r' for 'remove')
# remove_met <- c() # TO BE ADDED IN FUTURE VERSION OF DATA QUALITY CHECK DOCUMENT


```


# Internal Standard Check
## Signal Intensity

```{r IS SIGNAL INTENSITY CHECK}
# load libraries----
library(tidyverse)
library(data.table)

# load data----
met_data <- setDT(read.delim(data_file))

#  ***SIGNAL INTENSITY OF IS FOR EACH SAMPLE TYPE***
ggplot(met_data[area > 0 & sample_type %in% sample_grps & is == "y"], aes(x = component_name, y = log10(area), fill = sample_type)) +
  geom_boxplot(outlier.color = NA) +
  geom_jitter(pch = 21, color = "black", position = position_jitterdodge(dodge.width = 0.75, jitter.width = 0.2)) +
  theme(
    axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
    plot.background = element_rect(color = "black")
  ) +
  labs(x = "Standards", y = "log10(peak area)", fill = "Sample Group")


```

**Figure 1. Signal intensity of internal standards.** Intensities of each of the internal standards are plotted as boxplots for each sample type. Each individual sample is plotted as a single point overlaid on the boxplot. Points above or below the stems of the boxplot are outliers.

---

## Injection order

```{r INJECTION ORDER}
# ***INJECTION ORDER IS SIGNAL INTENSITY***
ggplot(met_data[area > 0 & sample_type %in% sample_grps & is == "y"], aes(x = sample_no, y = log10(area), color = sample_type)) +
  geom_point(size = 1) +
  geom_line(linewidth = 0.5) +
  facet_wrap(vars(component_name)) +
  theme(
    strip.text = element_text(size = 6, hjust = 0, margin = margin()),
    plot.background = element_rect(color = "black")
  ) +
  labs(x = "Injection order", y = "log10(peak area)", color = "Sample Group")

```

**Figure 2. Signal intensity of internal standards across injection sequence.** Intensities of each of the internal standards are plotted by injection order. Colors indicate sample type.

---

# Sample Data Check

## Retention Time Variability

```{r RT CHECK}
# ***RETENTION TIME OF METABOLITES***
met_names <- unique(met_data[is == "n" & rt > 0 & sample_type %in% sample_grps]$component_name)

if (length(met_names) <= 64) {
  
  # Produce one plot
  ggplot(met_data[is == "n" & sample_type %in% sample_grps & rt > 0], aes(x = component_name, y = rt, fill = sample_type)) +
    geom_boxplot(outlier.size = 0.2) +
    theme(
      axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
      plot.background = element_rect(color = "black")
    ) +
    labs(title = "RT of Metabolites", x = "Metabolite", y = "RT\n(min)", fill = "Sample Group")
  
} else {
  
  # Produce more than one plot
  no_plots <- ceiling(length(met_names) / 64) # calculates the number of plots to produce
  
  met_ids <- vector("list", no_plots)
  
  for (i in seq_along(seq(1:no_plots))) {
    
    met_ids[[i]] <- seq((i * 64) - 63, i * 64)
    
  }
  
  list_of_plots <- vector("list", no_plots)
  
  for (i in seq_along(met_ids)) {
    
    list_of_plots[[i]] <- ggplot(met_data[is == "n" & sample_type %in% sample_grps & rt > 0][component_name %in% met_names[met_ids[[i]]]], aes(x = component_name, y = rt, fill = sample_type)) +
      geom_boxplot(outlier.size = 0.2) +
      theme(
        axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
        plot.background = element_rect(color = "black")
      ) +
      labs(title = paste0("RT of Metabolites ",(i * 64) - 63,"-",i * 64), x = "Metabolite", y = "RT\n(min)", fill = "Sample Group")
    
    print(list_of_plots[i])
    
  }
  
}
```

**Figure 3. Retention time of each metabolite.** Retention times are plotted as boxplots for each sample type and each metabolite.

---

## Signal Intensity of All Detected Compounds

```{r SAMPLE BOXPLOTS}
# ***SIGNAL INTENSITY OF BIOLOGICAL METABOLITES (TOTAL) FOR EACH SAMPLE***
ggplot(met_data[is == "n" & sample_type %in% sample_grps & area > 0], aes(x = paste0(sample_type,"_",sample_no), y = log10(area), fill = sample_type)) +
  geom_boxplot(outlier.color = "black") +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
        plot.background = element_rect(color = "black")) +
  labs(x = "Sample", y = "log10(peak area)", fill = "Sample Group")
```

**Figure 4. Signal intensity of biological metabolites.** Boxplots show the distribution of the signal intensities for all biological metabolites detected for each sample and colored by each sample type.

---

## Signal Intensity of Individual Metabolites

```{r METABOLITE SIGNAL INTENSITY CHECK}
# ***SIGNAL INTENSITY OF BIOLOGICAL METABOLITES INDIVIDUALLY FOR EACH SAMPLE***
if (length(met_names) <= 64) {
  
  # Produce one plot
  ggplot(met_data[is == "n" & sample_type %in% sample_grps & area > 0][component_name %in% met_names], aes(x = paste0(sample_type,"_",sample_no), y = log10(area), color = sample_type)) +
  geom_point(size = 0.5) +
  theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
        strip.text = element_text(hjust = 0, size = 6, margin = margin()),
        plot.background = element_rect(color = "black")) +
  labs(title = paste0("Metabolites 1-",length(met_names)), x = "Sample", y = "log10(peak area)", color = "Sample Group") +
  facet_wrap(vars(component_name))
  
} else {
  
  # Produce more than one plot
  no_plots <- ceiling(length(met_names) / 64) # calculates the number of plots to produce
  
  met_ids <- vector("list", no_plots)
  
  for (i in seq_along(seq(1:no_plots))) {
    
    met_ids[[i]] <- seq((i * 64) - 63, i * 64)
    
  }
  
  list_of_plots <- vector("list", no_plots)
  
  for (i in seq_along(met_ids)) {
    
    list_of_plots[[i]] <- ggplot(met_data[is == "n" & sample_type %in% sample_grps & area > 0][component_name %in% met_names[met_ids[[i]]]], aes(x = paste0(sample_type,"_",sample_no), y = log10(area), color = sample_type)) +
      geom_point(size = 0.5) +
      theme(axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
        strip.text = element_text(hjust = 0, size = 6, margin = margin()),
        plot.background = element_rect(color = "black")) +
      labs(title = paste0("Metabolites ",(i * 64) - 63,"-",i * 64), x = "Sample", y = "log10(peak area)", fill = "Sample Group") +
      facet_wrap(vars(component_name))
    
    print(list_of_plots[i])
    
  }
  
}

```

**Figure 5. Signal intensity of each biological metabolite.** Scatter plots show the distribution of the signal intensities for all biological metabolites detected for each sample and colored by each sample type. Each subplot represents a specific metabolite.

---

# Appendix
## R Version and Packages Used

`r R.version.string` was used to analyze the data and generate this report. The following R packages were also used:

```{r R PACKAGE VERSIONS}

otherPkgs <- names(sessionInfo()[["otherPkgs"]])
pkgs_vers <- vector("character", length(otherPkgs))
for (i in seq_along(otherPkgs)) {
  
  pkgs_vers[[i]] <- sessionInfo()[["otherPkgs"]][[otherPkgs[i]]][["Version"]]
  
}

for (i in seq_along(otherPkgs)) {
  
  print(paste0(otherPkgs[[i]], " ", pkgs_vers[[i]]))
  
}

```











